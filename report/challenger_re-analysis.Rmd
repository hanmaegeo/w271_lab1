---
title: "W271 Group Lab 1"
subtitle: "Investigating the 1986 Space Shuttle Challenger Accident"
author: "Nathan Martinez, Meera Sharma, Hannah George, and Haile Bizunehe"
fontsize: 11pt
geometry: margin=1in
documentclass: exam
classoption: answers
output: 
  pdf_document: 
    toc: true
    number_sections: true
---

\newpage

```{r load packages, message=FALSE, warning=FALSE, echo=FALSE}
list.of.packages <- c("tidyverse", "sandwich", "lmtest", "car", "MASS", "nnet")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(sandwich)
library(lmtest)
library(car)
library(MASS)
library(nnet)
library(gridExtra)
```

\newpage

```{=tex}
\begin{abstract} 
This report will, indeed, be abstract. No, instead, describe your goals your approach, and what you learn.
\end{abstract}
```
# Introduction

## Research question

\begin{solution} \\
INSERT WRITUP HERE.
\end{solution}

# Data (20 points)

**Complete the following task. In your final submission, please remove this question prompt so that your report reads as a report. The Data Section of this report is worth 20 points.**

-   Conduct a thorough EDA of the data set.

    -   This should include both graphical and tabular analysis as taught in this course.
    -   Since the report has a page-limit, you will have to be selective when choosing visuals to illustrate your key points, associated with a concise explanation of the visuals.

-   This EDA should begin with an inspection of the given dataset; examination of anomalies, missing values, potential of top and/or bottom code etc.

```{r}
df <- read_csv('../data/raw/challenger.csv')
```
```{r}
summary(df)
```
```{r, echo=FALSE}
options(repr.plot.width = 1, repr.plot.height =1)

p1 <- ggplot(df, aes(x = Temp, y = factor(O.ring)), fig(1, 1)) + 
  geom_point() + 
  labs(title = "O-Ring Failures by Temperature") +
  ylab("Number of O-Ring Failures") +
  xlab("Temperature")

p2 <- ggplot(df, aes(x = Pressure, y = factor(O.ring)), fig(1, 1)) + 
  geom_point() + 
  labs(title = "O-Ring Failures by Pressure") +
  ylab("Number of O-Ring Failures") +
  xlab("Pressure")

grid.arrange(p1, p2, nrow = 1, ncol = 2)
```

```{r, echo=FALSE}
# Flattening the data for density plotting purpose
df2 <- data.frame(Temp = integer(),
                  Pressure = integer(),
                  O.ring.failed = integer())

count <- 0
for(i in 1:nrow(df)) {
  for(j in 1:6) {
    count <- count+1
    df2[count, "Temp"] <- df[i, "Temp"]
    df2[count, "Pressure"] <- df[i, "Pressure"]
    if (j <= as.numeric(df[i, "O.ring"])) {
      df2[count, "O.ring.failed"] <- "Yes"
      df2[count, "color"] <- "#35C1C4"
    } else {
      df2[count, "O.ring.failed"] <- "No"
      df2[count, "color"] <- "#EB675F"
    }
  }
}

df2$O.ring.failed <- factor(df2$O.ring.failed, levels=c("Yes", "No"))
p3 <- df2 %>% 
  ggplot(aes(x = Temp)) +
  geom_density(aes(y = ..density..,color = O.ring.failed, fill = O.ring.failed),
               alpha=0.2, trim = TRUE) +
  ggtitle("Distribution of temperature") + 
  theme(plot.title = element_text(lineheight=1, face="bold")) +
  xlab("Temperature") +
  ylab("O-ring failure")

p4 <- df2 %>% 
  ggplot(aes(x = Pressure)) +
  geom_density(aes(y = ..density..,color = O.ring.failed, fill = O.ring.failed),
               alpha=0.2, trim = TRUE) +
  ggtitle("Distribution of pressure") + 
  theme(plot.title = element_text(lineheight=1, face="bold")) +
  xlab("Pressure") +
  ylab("O-ring failure")

grid.arrange(p3, p4, nrow = 1, ncol = 2)
```

```{r, echo=FALSE}
# Plotting admission ratio
p5 <- df2 %>%
  ggplot(aes(x=O.ring.failed, y = ..prop.., group = 1)) + 
  geom_bar(fill = 'DarkBlue', color = 'black') +
  geom_text(stat='count', aes(label=round(..prop.., 2)), vjust=-1) + 
  ggtitle("O-ring failure proportion") + 
  theme(plot.title = element_text(size=11, lineheight=1, face="bold")) +
  xlab("O-ring failed") +
  ylab("Proportion") +
  ylim(0,1)

# Plotting failure ratios
p6 <- df %>%
  ggplot(aes(Temp, Pressure, colour = factor(O.ring))) +
  geom_point() +
  ggtitle("Distribution for failed O.ring") + 
  theme(plot.title = element_text(size=11, lineheight=1, face="bold")) +
  xlab("Temperature") +
  ylab("Pressure") +
  scale_colour_manual(name = 'Failed O.ring', guide = 'legend',
                      values = c('0' = 'green', '1' = 'blue', '2' = 'red'),
                      labels = c('0', '1', '2'))

grid.arrange(p5, p6, nrow = 1, ncol = 2, widths = c(1,2))
```
```{r, echo=FALSE}
p7 <- ggplot(df, aes(x = factor(O.ring), y = Temp, group = O.ring)) + 
  geom_boxplot() +
  labs(title = "O-Ring Failures by Temperature") +
  geom_jitter(width = 0.25) +
  ylab("Temperature") +
  xlab("Number of O-Ring Failures")

p8 <- ggplot(df, aes(x = factor(O.ring), y = Pressure, group = O.ring)) + 
  geom_boxplot() +
  labs(title = "O-Ring Failures by Pressure") +
  geom_jitter(width = 0.25) +
  ylab("Pressure") +
  xlab("Number of O-Ring Failures")

grid.arrange(p7, p8, nrow = 1, ncol = 2)
```



\begin{solution} \\
Based on the scatter plots above, we can see there is a negative relationship between temperature and the number of O-ring failures, that is, as temperature increases the number of O-ring failures appears to decrease. This intuition is confirmed when we look at the box plot, with both the mean and quantiles for temperature decreasing as number of O-ring failures increases.

However, there does not appear to be much of a relationship at all when we look at pressure. The scatter plot appears randomly distributed and the box plot is non descriptive at best.
\end{solution}

## Description

**Complete the following task. In your final submission, please remove this question prompt so that your report reads as a report.**

-   Describe the data that you are using. How is this data generated, what is the sampling process that brought it to your availability. If it is helpful, you might describe the population (i.e. the Random Variables) that exist and how samples are produced from these random variables.
-   The authors use logistic regression to estimate the probability an O-ring will fail. In order to use this model, the authors needed to assume that each O-ring is independent for each launch. Discuss why this assumption is necessary and the potential problems with it. Note that a subsequent analysis helped to alleviate the authors' concerns about independence.

\begin{solution} \\
INSERT WRITEUP HERE.
\end{solution}

## Key Features

\begin{solution} \\
INSERT WRITUP HERE.
\end{solution}

# Analysis

## Reproducing Previous Analysis (10 points)

**Your analysis should address the following two questions. In your final submission, please remove this question prompt so that your report reads as a report.**

1.  Estimate the logistic regression model that the authors present in their report -- include the variables as linear terms in the model. Evaluate, using likelihood ratio tests, the statistical significance of each explanatory variable in the model. Evaluate, using the context and data understanding that you have created in the **Data** section of this report, the practical significance of each explanatory variable in the model.

```{r}
model_1 <- glm(formula = O.ring / 6 ~ Temp + Pressure, data = df,
               family = 'binomial', weights = Number)

Anova(model_1, test = 'LR')
```
\begin{solution} \\
Based on the results of the likelihood ratio test, and the EDA performed above, the pressure variable does not appear to have either a statistically significant or practically significant effect on the number of O-ring failures. However, temperature does appear to be significant and should be used in whichever model we create.
\end{solution}

2.  Dalal, Fowlkes, and Hoadley (1989) chose to remove `pressure` from the model based on their likelihood ratio tests. Critically evaluate, using your test results and understanding of the question and data, whether `pressure` should be included in the model, or instead, `pressure` should not be included in the model. Your report needs to make a determination, argue why it is most appropriate choice, and make note of how (if at all) the model results are affected by the choice of including or excluding `pressure`.

\begin{solution} \\
Based on the results of the likelihood ratio test above, we would also conclude that the pressure variable should not be included in the model. The effect of the variable is not statistically significant, and the scatter plot of pressure versus number of O-ring failures shows no correlation between the two.
\end{solution}

## Confidence Intervals (20 points)

No matter what you determined about using or dropping `pressure`, for this section begin by considering the simplified model $logit(\pi) = \beta_0 + \beta_1 Temp$, where $\pi$ is the probability of an O-ring failure. Complete the following:

1.  Estimate the logistic regression model.
2.  Determine if a quadratic term is needed in the model for the temperature in this model.
3.  Construct two plots:
4.  $\pi$ vs. Temp; and,
5.  Expected number of failures vs. Temp.

Specific requirements for these plots:

-   Use a temperature range of 31° to 81° on the x-axis even though the minimum temperature in the data set was 53°.\
-   Include the 95% Wald confidence interval bands for $\pi$ on the plot. Describe, in your analysis of these plots, why the bands much wider for lower temperatures than for higher temperatures?

```{r}
# 1. Estimate the logistic regression model.
model_2 <- glm(formula = O.ring / 6 ~ Temp, data = df, family = 'binomial',
               weights = Number)
summary(model_2)
```

```{r}
# 2. Determine if a quadratic term is needed in the model for the temperature in
#    this model.
model_3 <- glm(formula = O.ring / 6 ~ Temp + I(Temp ^ 2), data = df,
               family = 'binomial', weights = Number)

Anova(model_3)
```

```{r}
# Pi vs Temp plot.
res <- data.frame(Temp = 31:81)
pred_prob <- predict(model_3, res, type="response", se = TRUE)
res['pi_hat'] <- pred_prob$fit
res['lower'] <- pred_prob$fit - qnorm(1 - 0.05 / 2) * pred_prob$se.fit
res['upper'] <- pred_prob$fit + qnorm(1 - 0.05 / 2) * pred_prob$se.fit

ggplot(res, aes(x = Temp, y = pi_hat)) + 
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) + 
  labs(title = "Predicted Probability of O-Ring Failure vs Temperature") +
  ylab("Pi") +
  xlab("Temperature")
```

```{r}
# Expected number of failures vs Temp plot.
pred <- predict(model_3, res, se = TRUE)
res['pred_failures'] <- pred$fit
res['failures_lower'] <- pred$fit - qnorm(1 - 0.05 / 2) * pred$se.fit
res['failures_upper'] <- pred$fit + qnorm(1 - 0.05 / 2) * pred$se.fit

ggplot(res, aes(x = Temp, y = pred_failures)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = failures_lower, ymax = failures_upper), alpha = 0.2) + 
  labs(title = "Predicted Number of O-Ring Failure vs Temperature") +
  ylab("O-Ring Failures") +
  xlab("Temperature")
```
\begin{solution} \\
After looking at the likelihood ratio tests for a quadratic term, we would conclude that it is not necessary to include in the model.
\end{solution}


3.  The temperature was 31° at launch for the Challenger in 1986. Estimate the probability of an O-ring failure using this temperature, and compute a corresponding confidence interval. Discuss what assumptions need to be made in order to apply the inference procedures.

\begin{solution} \\
When the temperature is 31°, the estimated probability of O-ring failure is `r round(res[res$Temp == 31,]['pi_hat'], 4)` (`r round(res[res$Temp == 31,]['lower'], 4)`, `r round(res[res$Temp == 31,]['upper'], 4)`).
\end{solution}

## Bootstrap Confidence Intervals (30 points)

Rather than relying on asymptotic properties, consider using a parametric bootstrap, as did Dalal, Fowlkes and Hoadley. To do this:

1.  Simulate a large number of data sets (n = 23 for each) by re-sampling with replacement from the data.
2.  Estimate a model for each dataset.
3.  Compute the effect at a specific temperature of interest.

To produce a confidence interval, the authors used the 0.05 and 0.95 observed quantiles from the simulated distribution as their 90% confidence interval limits.

Using the parametric bootstrap, compute 90% confidence intervals separately at each integer temperature between 10° and 100° Fahrenheit.

In this section, you should describe your process, justify such a process, and present your results in a way that is compelling for your reader.

```{r bootstrap-confidence-intervals}
incidents.estimator <- function(b, seed=42, number=6) {
  # To ensure that the simulations can be reproduced exactly
  set.seed(seed)
  n <- 23 # Resampled size
  estimation <- array(data = NA, dim=c(91, b))
  
  # Performing re-sampling repeatedly "b" times
  for(i in 1:b) {
    samples <- sample(x = 1:n, size = n, replace = TRUE)
    model   <- glm(formula = O.ring / Number ~ Temp, data = df[samples,],
                   weights = Number, family = 'binomial')
    # Performing prediction for 10-100° Fahrenheit using each fitted model 
    for(t in 10:100) {
      p <- predict(object = model, newdata = data.frame(Temp = t),
                   type = "response")
      estimation[t-9, i] <- p
    }
  }

  # Fitting a model with the original data for prediction
  model <- glm(formula = O.ring/6 ~ Temp, data = df,
               weights = Number, family = 'binomial')
  # Estimating Expected number of incidents along with 90% CI
  incidents <- data.frame(Temperature = integer(),
                          Incidents = double(),
                          CI.Upper = double(),
                          CI.Lower = double())
  for(t in 10:100) {
    i <- t-9 # Index to locate data in the data.frame
    p <- predict(object = model, newdata = data.frame(Temp = t),
                 type = "response")
    # Getting the 90% CI and multiply by 6 to get estimation for a single flight
    ci <- quantile(estimation[i,], probs = c(0.05, 0.95), names=FALSE)
    incidents[i, 1] <- t
    incidents[i, 2] <- p*number
    incidents[i, 3] <- ci[1]*number
    incidents[i, 4] <- ci[2]*number
  }

  incidents
}

# Performing predictions for 10°-100° temperature and plotting the result
predicted.incidents <- incidents.estimator(1000)

ggplot(predicted.incidents, aes(x=Temperature)) + 
  geom_line(aes(y = Incidents)) + 
  geom_line(aes(y = CI.Upper), color = "gray", linetype="dashed", size = 1) + 
  geom_line(aes(y = CI.Lower), color = "gray", linetype="dashed", size = 1) +
  scale_y_continuous(breaks = seq(0, 6, by = 1)) +
  scale_x_continuous(breaks = seq(10, 100, by = 20)) +
  labs(title = "Expected number of incidents by temperature") +
  xlab("Temperature in degree fahrenheit") +
  ylab("Expected number of incidents") +
  theme_linedraw()
```

## Alternative Specification (10 points)

With the same set of explanatory variables in your final model, estimate a linear regression model. Explain the model results; conduct model diagnostic; and assess the validity of the model assumptions. Would you use the linear regression model or binary logistic regression in this case? Explain why.

\begin{solution} \\
INSERT WRITEUP HERE.
\end{solution}

# Conclusions (10 points)

Interpret the main result of your preferred model in terms of both odds and probability of failure. Summarize this result with respect to the question(s) being asked and key takeaways from the analysis.

\begin{solution} \\
INSERT WRITEUP HERE.
\end{solution}
